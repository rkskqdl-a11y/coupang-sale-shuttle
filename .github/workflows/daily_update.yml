name: Scheduled Daily Automation and Manual Dispatch

on:
  schedule:
    # í•˜ë£¨ 4ë²ˆ (ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 9ì‹œ, ìƒˆë²½ 3ì‹œ) ì‹¤í–‰í•˜ë„ë¡ ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ìœ ì§€
    - cron: '0 0,6,12,18 * * *'
  
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
    inputs:
      log_level:
        description: 'ì‹¤í–‰ ë¡œê·¸ ìˆ˜ì¤€'
        required: false
        default: 'info'
        type: choice
        options: [info, debug, warn]

permissions:
  contents: write
  id-token: write

jobs:
  automation-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4 # ìµœì‹  v4 ê¶Œì¥
        with:
          persist-credentials: true
          fetch-depth: 1

      - name: Configure Python Environment
        uses: actions/setup-python@v5 # ìµœì‹  v5 ê¶Œì¥
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
          pip install requests google-generativeai

      - name: Execute Automation Script
        # ğŸ’ í•µì‹¬: ê¸°ì¡´ì— ì“°ë˜ API í‚¤ë“¤ì„ ì—¬ê¸°ì— ë°˜ë“œì‹œ ë„£ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ í¬ìŠ¤íŒ… ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
          python main.py # ğŸ’ ì‹¤ì œ ìš°ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—¬ê¸°ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.

      - name: Synchronize Changes to Repository
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # ë³€ê²½ëœ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì•ˆì „í•˜ê²Œ ì €ì¥
          if ! git diff-index --quiet HEAD; then
            echo "ìƒˆë¡œìš´ í¬ìŠ¤íŒ…ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ì†Œì— ë°˜ì˜í•©ë‹ˆë‹¤."
            git commit -m "chore: ì¼ì¼ ìë™ ì—…ë°ì´íŠ¸ ($(date +'%Y-%m-%d')) [skip ci]"
            git push
          else
            echo "ì¶”ê°€ëœ í¬ìŠ¤íŒ…ì´ ì—†ìŠµë‹ˆë‹¤. ì‘ì—…ì„ ì¢…ë£Œí•©ë‹ˆë‹¤."
          fi
        shell: bash
